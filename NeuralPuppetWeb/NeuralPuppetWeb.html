<!DOCTYPE html>

<html>
    
    <head>
        <meta charset='utf-8'/>
        <title>Neural Puppet Web Port</title>
        
        <script type="text/javascript" src="./js/jsgif/LZWEncoder.js"></script>
        <script type="text/javascript" src="./js/jsgif/NeuQuant.js"></script>
        <script type="text/javascript" src="./js/jsgif/GIFEncoder.js"></script>
        <script type="text/javascript" src="./js/jsgif/b64.js"></script>

        <script type='text/javascript' src='./js/canvasy/canvasy.js'></script>
        <script type='text/javascript' src='./js/animation.js'></script>
        <script type='text/javascript' src='./js/grid.js'></script>
        <script type='text/javascript' src='./js/display.js'></script>
        <script type='text/javascript' src='./js/renderer.js'></script>
        <script type='text/javascript' src='./js/ui.js'></script>

        <script type='text/javascript'>

        // Windows
        var grid;
        var display;
        var test;
        // Animation
        var animation;
        var renderer;

        // Utilities
        var cur_timestamp; // For calculating fps
        var fps;

        // UI
        var timeline;
        var play;

        function init()
        {
            animation = new Animation();
            animation.data.set_grid_image('./imgs/open_smile.png', 7, 7);

            grid = new Grid();
            display = new Display();
            renderer = new Renderer();
            timeline = new Timeline();
            play = new Play();
            cur_timestamp = time();
            
            register_events(); // Window level events
            resize_windows(); 

            start_loop(loop);
        }

        function loop()
        {
            animation.update_cursor(grid.canvas.mouse_x/ grid.canvas.width,
                                    grid.canvas.mouse_y/ grid.canvas.height);
            animation.update();

            grid.update();
            display.update();

            calculate_fps();
            get_id('fps').innerText = fps + ' FPS'

            get_id('timeline-counter').innerText = animation.current_frame + ' / ' + (animation.data.path.length-1);
        }

        function start_render()
        {   renderer.setup_render(animation.data, animation.data.path.length-1);
            renderer.start_render();
        }
        /*
        function update_render()
        {   renderer.update_frame();
        }

        function stop_render()
        {
            renderer.finish_render();
        }
        */

        // UI
        function resize_windows()
        {   // Positions and resizes windows. 
            // parseFloat() is used to get values or
            // they will return with 'px' at the end 
            let window_width = window.innerWidth/2;

            // Limit max size
            if(window_width > 500) window_width = 500;
           
            grid.canvas.element.style.top = '0px';
            grid.canvas.element.style.left = '0px';
            grid.canvas.width = window_width;
            grid.canvas.height = parseFloat(grid.canvas.width);

            display.canvas.element.style.top = parseFloat(grid.canvas.element.style.top) + 'px';
            display.canvas.element.style.left = parseFloat(grid.canvas.element.style.left) + parseFloat(grid.canvas.width) + 'px';
            display.canvas.width = window_width;
            display.canvas.height = parseFloat(grid.canvas.height);

            get_id('timeline').style.width = window_width*2 + 'px';
        }

        // EVENTS
        function on_resize()
        {   // Called with window is resized
            resize_windows();
        }

        function register_events()
        {   // Register any document / window level events here
            window.onresize = on_resize;
        }

        // UTILITY
        function get_id(id)
        {   // Shortify wrapper to get elements
            return document.getElementById(id);
        }

        function start_loop(func)
        {   // Wrapper to loop a function using requestAnimationFrame()
            var looped = function()
            {   func();
                window.requestAnimationFrame(looped);
            }
            var animation_request = requestAnimationFrame(looped);
            // Returns the animation request ID, so you can stop it 
            // using cancelAnimationFrame() 
            return animation_request; 
        }

        function calculate_fps()
        {   // Calculates FPS
            let time_diff = time() - cur_timestamp;
            cur_timestamp = time();
            fps = (1000/time_diff).toFixed(1);
        }

        function time()
        {   // Wrapper for performance.now()
            return performance.now();
        }

        </script>

        <style type='text/css'>
            html, body
            {   width: 100%;
                height: 100%;
                padding: 0px;
                margin: 0px;
                /*overflow: hidden;*/
            }

            #anim-windows
            {   position: relative;
                width: 100%;
                height: auto;
            }

            #anim-grid
            {   position: relative;
                background-color: grey;
                cursor: cell;
            }

            #anim-display
            {   position: absolute;
                background-color: cyan;
            }

            #fps
            {   font-family: Arial, Helvetica, sans-serif;
            }

            .no-space
            {   padding: 0px;
                margin: 0px;
            }

            #timeline
            {   margin-top:15px;
                display: block;
            }

            .readout
            {   margin-left: 10px;
                margin-bottom: 10px;
                display: inline-block;
                font-family: Arial, Helvetica, sans-serif;
            }

            .button
            {   float: left;
                margin: 10px;
                padding: 5px;
            }

            .wide
            {   width: 100%;
                display: inline-block;
                /*background-color:red;*/
            }

            #render_result
            {   width: 500px;
            }
            
        </style>
    </head>

    <body onload='init()'>
        <div id='anim-windows' class='no-space'>
            <canvas id='anim-grid'></canvas>
            <canvas id='anim-display'></canvas>
        </div>

        <input type='range' id='timeline' value='5000'>
        
        <div class='wide'>
            <button id='play-button' class='button'>PLAY</button>
            <p id='timeline-counter' class='readout'></p>
        </div>

        <div class='wide'>
            <button id='render-button' class='button' onclick='start_render()'>RENDER</button>
            <p id='render-status' class='readout'>NOT RENDERING</p>
        </div>

        <div class='wide'>
            <p id='fps' class='readout'></p>
        </div>

        <div class='wide'>
            <img id='render_result'>
        </div>

    </body>

</html>